"""
Unified Communication X (UCX) is an award winning, optimized production proven-communication framework for modern, high-bandwidth and low-latency networks.
"""

load("@//third_party/openucx:utils.bzl", "file_filter")
load("@rules_cc//cc:defs.bzl", "cc_library")
load("@rules_foreign_cc//foreign_cc:defs.bzl", "configure_make")

package(default_visibility = ["//visibility:public"])

filegroup(
    name = "all_srcs",
    srcs = glob(["**"]),
    visibility = ["//visibility:public"],
)

exports_files(["BUILD.bazel"])

configure_make(
    name = "ucx",
    args = [
        "-j$(nproc)",
    ],
    autogen = True,
    configure_command = "./contrib/configure-release-mt",
    configure_in_place = True,
    configure_options = [
        # "--enable-ucg",  # ucg is out-of-date, use ucc now
        "--with-avx",
        "--with-march",
        "--enable-compiler-opt",
        "--enable-optimizations",
        "--enable-cma",
        "--with-rc",
        "--with-ud",
        "--with-dc",
        "--with-ib-hw-tm",
        "--with-dm",
        "--enable-tuning",
        "--with-fuse3=guess",
        "--with-mad=guess",
        "--with-gdrcopy=guess",
        "--with-mlx5=guess",
        # "--with-verbs=guess",  # Seems OpenFabrics verbs not compatible with mlx5?
        "--with-rdmacm=guess",
        "--with-knem=guess",
        "--with-xpmem=guess",
        "--with-java=no",
        "--with-go=no",
    ] + select({
        "@rules_cuda//cuda:is_enabled": [
            "--with-cuda",
        ],
        "//conditions:default": [
        ],
    }),
    copts = [
        "-Wno-error",
        "-fPIC",  # Add position-independent code flag for shared library linking
    ],
    lib_source = "@ucx//:all_srcs",
    out_bin_dir = "bin",
    out_binaries = [
        "io_demo",
        "ucx_info",
        "ucx_perftest",
        "ucx_perftest_daemon",
        "ucx_read_profile",
    ],
    out_include_dir = "include",
    out_lib_dir = "lib",
    out_shared_libs = [
        "libucm.so",
        "libucm.so.0",
        "libucm.so.0.0.0",
        "libucp.so",
        "libucp.so.0",
        "libucp.so.0.0.0",
        "libucs_signal.so",
        "libucs_signal.so.0",
        "libucs_signal.so.0.0.0",
        "libucs.so",
        "libucs.so.0",
        "libucs.so.0.0.0",
        "libuct.so",
        "libuct.so.0",
        "libuct.so.0.0.0",
        # ucx directory prefix has been removed
        "libuct_cma.so",
        "libuct_cma.so.0",
        "libuct_cma.so.0.0.0",
        "libuct_ib.so",
        "libuct_ib.so.0",
        "libuct_ib.so.0.0.0",
        "libuct_ib_mlx5.so",
        "libuct_ib_mlx5.so.0",
        "libuct_ib_mlx5.so.0.0.0",
    ] + select({
        "@rules_cuda//cuda:is_enabled": [
            # ucx directory prefix has been removed
            "libucm_cuda.so",
            "libucm_cuda.so.0",
            "libucm_cuda.so.0.0.0",
            "libuct_cuda.so",
            "libuct_cuda.so.0",
            "libuct_cuda.so.0.0.0",
        ],
        "//conditions:default": [
        ],
    }),
    out_static_libs = [
        "libucm.a",
        "libucp.a",
        "libucs_signal.a",
        "libucs.a",
        "libuct.a",
        # ucx directory prefix has been removed
        "libuct_cma.a",
        "libuct_ib.a",
        "libuct_ib_mlx5.a",
    ] + select({
        "@rules_cuda//cuda:is_enabled": [
            "libucm_cuda.a",
            "libuct_cuda.a",
        ],
        "//conditions:default": [
        ],
    }),
    visibility = ["//visibility:public"],
    deps = select({
        "@rules_cuda//cuda:is_enabled": [
            "@rules_cuda//cuda:runtime",
        ],
        "//conditions:default": [
        ],
    }),
)

filegroup(
    name = "ucx_gen_dir",
    srcs = [":ucx"],
    output_group = "gen_dir",
    visibility = ["//visibility:public"],
)

filegroup(
    name = "ucx_libs_all",
    srcs = [":ucx"],
    visibility = ["//visibility:public"],
)

file_filter(
    name = "ucx_shared_libs",
    srcs = [":ucx"],
    extensions = [
        ".so",
        ".so.0",
        ".so.0.0.0",
    ],
    visibility = ["//visibility:public"],
)

file_filter(
    name = "ucx_static_libs",
    srcs = [":ucx"],
    extensions = [".a"],
    visibility = ["//visibility:public"],
)

filegroup(
    name = "_ucx_header_includes",
    srcs = [":ucx"],
    output_group = "include",
)

cc_library(
    name = "ucx_headers",
    hdrs = [
        ":_ucx_header_includes",
    ],
    includes = ["ucx/include"],
    visibility = ["//visibility:public"],
)

# Shared libs only
cc_library(
    name = "ucx_prebuilt_shared",
    srcs = [
        ":ucx_shared_libs",
    ],
    linkopts = [
        "-Wl,--as-needed",
    ],
    visibility = ["//visibility:public"],
)

# Static libs only
cc_library(
    name = "ucx_prebuilt_static",
    srcs = [
        ":ucx_static_libs",
    ],
    linkopts = [
        "-Wl,--as-needed",
    ],
    visibility = ["//visibility:public"],
)

# Backward compatibility alias (points to shared by default to avoid accidental static linking issues in dynamic builds)
# But strictly speaking, "prebuilt" implied everything before.
# To be safe for mixed usage, we alias to shared, as static users should use static targets.
# However, existing targets like `ucs` use `linkstatic = False`, so they want shared.
alias(
    name = "ucx_prebuilt",
    actual = ":ucx_prebuilt_shared",
    visibility = ["//visibility:public"],
)

cc_library(
    name = "ucm",
    includes = ["ucx/include"],
    linkopts = [
        "-Wl,--as-needed",
    ],
    linkstatic = False,
    deps = [
        ":ucx_headers",
    ],
)

cc_library(
    name = "ucm_static",
    includes = ["ucx/include"],
    linkopts = [
        "-Wl,--as-needed",
    ],
    linkstatic = True,
    deps = [
        ":ucx_headers",
    ],
)

cc_library(
    name = "ucs_signal",
    linkstatic = False,
    deps = [
        ":ucx_headers",
    ],
)

cc_library(
    name = "ucs_signal_static",
    linkstatic = True,
    deps = [
        ":ucx_headers",
    ],
)

cc_library(
    name = "ucs",
    linkopts = [
        "-Wl,--undefined=ucs_init,--as-needed",
        "-ldl",
        "-lrt",
        "-lm",
        "-pthread",
    ],
    linkstatic = False,
    visibility = ["@ucc//:__pkg__"],
    deps = [
        ":ucm",
        ":ucs_signal",
        ":ucx_headers",
        ":ucx_prebuilt_shared",
    ],
)

cc_library(
    name = "ucs_static",
    linkopts = [
        "-Wl,--undefined=ucs_init,--as-needed",
        "-ldl",
        "-lrt",
        "-lm",
        "-pthread",
    ],
    linkstatic = True,
    visibility = ["@ucc//:__pkg__"],
    deps = [
        ":ucm_static",
        ":ucs_signal_static",
        ":ucx_headers",
        ":ucx_prebuilt_static",
    ],
)

cc_library(
    name = "uct",
    linkopts = [
        "-Wl,--undefined=uct_init,--as-needed",
    ],
    linkstatic = False,
    deps = [
        ":ucs",
        ":ucx_headers",
        ":ucx_prebuilt_shared",
    ],
)

cc_library(
    name = "uct_static",
    linkopts = [
        "-Wl,--undefined=uct_init,--as-needed",
    ],
    linkstatic = True,
    deps = [
        ":ucs_static",
        ":ucx_headers",
        ":ucx_prebuilt_static",
    ],
)

cc_library(
    name = "ucp",
    linkopts = [
        "-Wl,--undefined=ucp_global_init,--as-needed",
    ],
    linkstatic = False,
    deps = [
        ":ucx_headers",
        ":ucx_prebuilt_shared",
    ],
)

cc_library(
    name = "ucp_static",
    linkopts = [
        "-Wl,--undefined=ucp_global_init,--as-needed",
    ],
    linkstatic = True,
    deps = [
        ":ucx_headers",
        ":ucx_prebuilt_static",
    ],
)

cc_library(
    name = "ucx_runtime",
    linkstatic = False,
    visibility = ["//visibility:public"],
    deps = [
        ":ucp",
        ":ucs",
        ":uct",
        ":ucx_headers",
    ],
)

cc_library(
    name = "ucx_runtime_static",
    linkstatic = True,
    visibility = ["//visibility:public"],
    deps = [
        ":ucp_static",
        ":ucs_static",
        ":uct_static",
        ":ucx_headers",
    ],
)
